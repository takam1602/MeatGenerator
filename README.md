### 作成者
北海道大学　鎌田樹
kmtttk1602*gmail.com にコンタクトください(*->@に変えてください)

# MeatGenerator - Pseudo meat images generator

- 疑似ロース芯画像ジェネレータ
- 疑似エダニク画像ジェネレータ

## 機能
エダニク画像を表示できるようにしてみました．
[Meat Generator V3.0](https://japanicmj-meatgenerator.firebaseapp.com/)

表示されるまで10秒ほどお待ちください．
それ以上待っても表示されなかったら，どこかがおかしいので連絡をください．

### 採点について
このプログラムでは実際の採点方法を真似しています．

ユーザーが入力した数列(2341など)と生成した画像から生成した答えの数列(1234など)を比較して，
- スプリットの算出
- スプリットを使用した採点
をして，点数を表示します．

スプリットとは2者比較した際の点数差，のようなもので，それを使って減点方式で最終的な点数を決定します．

スプリットとか採点方法については
[テキサスA&MのエクステンションセンターのPDF](https://texas4-h.tamu.edu/wp-content/uploads/2015/09/photo_judging_contest_reasons2.pdf)
をご覧ください．

採点のポイントは，見分けにくいペアでは減点は小さくが，見分けやすいペアでは減点は大きく，実行されるということです．

__見分けやすいペアを落とさずに取っていく__

ことがジャッジングセオリーです．

## ロース芯の生成について

ミートジャッジングの練習用に胸最長筋の脂肪交雑のような模様を出力します．

楕円面積、色、白い点の数と大きさのそれぞれに一定の範囲内で乱数を与え、描画しています．
白い点を脂肪交雑、とみなしてほしいのですが、これはフィルタを使用して脂肪交雑っぽく表現しています．
本当はチューリングパターンを用いていい感じの時間発展のところで止めて脂肪交雑っぽくしよう、という計画でした.(将来実装？)

- Areaは楕円の面積です．
- Beef Color Standard (BCS)は一応日本食肉格付け協会のBCS1－8までの範囲でランダムに生成しています．おおよそスタンダードに近い色が出ているのではないかと思います。
- Beef Marbling Standard (BMS)は楕円の面積と白く塗りつぶされている範囲の面積を算出し，その比を計算して推定しています．

[口田先生の論文](https://www.jstage.jst.go.jp/article/chikusan1924/68/9/68_9_853/_article/-char/ja/)
を参考に面積比からBMSを計算しています。

論文ではBMSを説明変数としたとき面積比は
![分布 bms vs ロース芯内脂肪面積比](https://user-images.githubusercontent.com/47586322/149666629-f2e647a6-e9ce-4e91-b6cc-fbfb4ca0f16f.png)

y= 4.418x + -7.184
決定係数 R^2：  0.98

となるようです．

逆推定
x = (y+7.184)/4.418
をしてみて，面積比からBMSを推定します．

## エダニク画像の生成について
最初はエダニク概形を曲線で表現してそれを近似できる曲線から少しずつパラメータを調整してやろうかなと思っていましたが，もっと簡単な方法で実装できないかと考えて，画像を学習してエダニクっぽい画像を生成する作戦に切り替えました．(学習などと言っていますが，なんちゃってです)

生成のフローは
- 学習用枝肉画像を用意する
- 学習する
- 学習データを出力する
- 出力されたデータを基に新しいデータを推論する
- 画像を描く
という感じです．

学習用のエダニク画像は
[Australian ICMjのオンラインツール]()
で使用されている画像を使用させていただきました．
エダニク画像ならば何でもよいのですが，他に枝肉画像が存在しなかったこと，背景が黒で前処理が不要だったこと，などの理由です．

画像たちを学習するのですが，最終的に欲しいデータはその枝肉の輪郭のデータです．
画像はピクセルで表現されているので，輪郭のピクセルデータを取得すればよいという考えになります．

[事前学習兼デバッグ用のコード](tools/CarcaseGeneratorPre/Program.cs)
にありますが，処理フローは
- 画像読み込み
- 画像リサイズ
- ノイズ除去
- 輪郭抽出
- 輪郭フィルタリング
- 輪郭座標を標準化
といった流れです．

高さ方向の標準化は処理していなかったので，書いたコードだともっとも高さのある枝肉の高さに統一されるものになってしまいましたが重要なのは幅なので高さの情報は無視しました．

学習結果のデータJson形式で
[carcaseData.json](JapaneseIcmj/wwwroot/json/carcaseData.json)
の通りですが，学習データというたいそうなものではなく，処理した輪郭座標の集まり，ということになります．


このデータを使って新しい輪郭を造ろうという話になるのですが,私は難しいことを考えたくなかったので，単純に平均と標準偏差を計算して，標準偏差だけずらして作成することにしました．
つまり，枝肉の輪郭データを高さ毎にスライスしていくと輪郭の左右のデータをとることができます．
今は高さ方向は統一されているとみなしているので正しくないですが，大まかに考えてもこの輪郭の左右位置の個体ごとによってばらついていると考えることができます．
その，高さ毎のばらつき具合は正規分布に載っていると仮定して，平均の位置から標準偏差倍だけずらすことで輪郭のばらつきを推定しようと考えました．

![gaussian](https://user-images.githubusercontent.com/47586322/152668979-dda05f4d-42a8-446a-99d2-11095cc387e9.png)

ばらつきのは
$$3\sigma$$
を最大に考えています．

だいぶ線形化というか処理を端折っているため正確ではないですが最終的な出来上がりはまあまあなのかなと思っています．

新しいアイディアがあったら是非一緒に作りましょう！！

## 支えていただいているツール
- [ASP.NET](https://dotnet.microsoft.com/en-us/apps/aspnet)
- [shimatさんのOpenCvSharp](https://github.com/shimat/opencvsharp)
- [firebase](https://firebase.google.com/)


